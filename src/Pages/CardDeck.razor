@page "/tarot"
@using System
@using System.Collections.Generic
@using System.Linq
@using System.Threading.Tasks
@using Markdig
@using Toolbox.Helpers
@using Toolbox.Models
@inject IndexedDbHelper DbHelper

<PageTitle>@DisplayTexts.TarotPageTitle</PageTitle>

@if (isLoadingDecks)
{
    <div class="tarot-loading" role="status" aria-live="polite">
        <div class="spinner-border text-primary me-3" aria-hidden="true"></div>
        <span class="tarot-loading-text">@DisplayTexts.TarotDeckLoading</span>
    </div>
}
else
{
    <div class="tarot-page">
        <h1>@DisplayTexts.TarotHeader</h1>

        <div class="tarot-search">
            <label class="form-label" for="cardNameInput">@DisplayTexts.TarotSearchLabel</label>
            <input id="cardNameInput"
                   class="form-control"
                   @bind="SearchTerm"
                   @bind:event="oninput"
                   placeholder="@DisplayTexts.TarotSearchPlaceholder"
                   disabled="@(!IsSearchEnabled)" />
        </div>

        <div class="tarot-search">
            <label class="form-label" for="deckSelection">@DisplayTexts.TarotDeckSelectionLabel</label>
            <select id="deckSelection"
                    class="form-select"
                    @bind="SelectedDeck">
                <option value="">@DisplayTexts.TarotDeckSelectionPlaceholder</option>
                @foreach (var option in DeckOptions)
                {
                    <option value="@option.DeckId">@option.DisplayName</option>
                }
            </select>
        </div>

        @if (HasSearched && selectedCard is null && !isLoadingCards)
        {
            <p class="text-danger">@DisplayTexts.TarotSearchNotFound</p>
        }

        @if (isLoadingCards && IsDeckSelected)
        {
            <div class="tarot-loading" role="status" aria-live="polite">
                <div class="spinner-border text-primary me-3" aria-hidden="true"></div>
                <span class="tarot-loading-text">@DisplayTexts.TarotDeckLoading</span>
            </div>
        }
        else if (selectedCard is not null)
        {
            <figure class="tarot-card">
                <img src="@selectedCard.ImageDataUrl" alt="@selectedCard.DisplayName" class="img-fluid" />
                <figcaption>@selectedCard.DisplayName</figcaption>
            </figure>

            <section class="tarot-card-description" aria-live="polite">
                @if (!string.IsNullOrEmpty(descriptionError))
                {
                    <p class="text-danger">@descriptionError</p>
                }
                else if (!string.IsNullOrEmpty(selectedCardDescriptionHtml))
                {
                    <div class="tarot-card-description-content">@((MarkupString)selectedCardDescriptionHtml)</div>
                }
            </section>
        }
    </div>

    @if (selectedCard is not null)
    {
        <nav class="tarot-navigation-bar" aria-label="@DisplayTexts.TarotHeader">
            <button type="button"
                    class="btn btn-outline-secondary"
                    aria-label="@DisplayTexts.TarotPreviousCardButton"
                    title="@DisplayTexts.TarotPreviousCardButton"
                    disabled="@(!CanNavigateCards)"
                    @onclick="ShowPreviousCardAsync">
                &larr;
            </button>

            <button type="button"
                    class="btn btn-outline-secondary"
                    aria-label="@DisplayTexts.TarotNextCardButton"
                    title="@DisplayTexts.TarotNextCardButton"
                    disabled="@(!CanNavigateCards)"
                    @onclick="ShowNextCardAsync">
                &rarr;
            </button>
        </nav>
    }
}


